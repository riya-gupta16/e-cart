<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meridian Marketplace - Cart</title>
    <link rel="stylesheet" href="css/styles.css"><script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6B87C7;
            --secondary-color: #8FA6D4;
            --accent-color: #5C77A2;
            --text-color: #fff;
            --bg-color: #1a1a1a;
            --card-bg: #2a2a2a;
            --success-color: #6A9362;
            --warning-color: #D4A574;
            --error-color: #C76B6B;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .sticky-header {
            background-color: var(--card-bg);
            padding: 1rem 0;
            border-bottom: 1px solid #444;
        }

        .main-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .logo { font-size: 1.5rem; font-weight: bold; color: #f0f4f0; text-decoration: none; }

        .cart-page { max-width: 900px; margin: 4rem auto; padding: 0 2rem; }
        .cart-page h1 { text-align: center; margin-bottom: 2rem; color: var(--primary-color); }

        .cart-item {
            display: flex;
            align-items: center;
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #444;
        }

        .cart-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-right: 1.5rem; }
        .cart-item-details { flex: 1; }
        .cart-item-price { font-weight: bold; color: var(--secondary-color); }

        .eco-points-badge {
            background: linear-gradient(135deg, var(--success-color), var(--warning-color));
            color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;
        }

        .sustainability-tracker { background-color: var(--card-bg); padding: 1.5rem; border-radius: 12px; margin: 2rem 0; border: 1px solid #444; }
        .progress-container { background-color: #333; height: 20px; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--success-color), var(--warning-color)); transition: width 0.5s ease; }

        .total-section { background-color: var(--card-bg); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--primary-color); margin: 2rem 0; }
        .price-row.final { font-weight: bold; font-size: 1.5rem; color: var(--success-color); border-top: 1px solid #444; padding-top: 0.5rem; }
        
        .checkout-btn { display: block; width: 100%; padding: 1rem; font-size: 1.25rem; font-weight: bold; color: #fff; background-color: var(--primary-color); border: none; border-radius: 8px; cursor: pointer; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 2rem; border-radius: 15px; width: 90%; max-width: 600px; position: relative; }
        .close { position: absolute; right: 1rem; top: 1rem; font-size: 2rem; cursor: pointer; }
    </style>
</head>
<body>
    <header class="sticky-header">
        <nav class="main-nav">
            <a href="index.html" class="logo">Meridian</a>
            <div class="nav-actions">
                <button class="cart-btn" onclick="window.location.href='cart.html'">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-count" class="cart-count">0</span>
                </button>
            </div>
        </nav>
    </header>

    <main class="cart-page">
        <h1>Your Shopping Cart</h1>
        <div id="cart-items" class="cart-items-container"></div>
        
        <div id="sustainability-tracker" class="sustainability-tracker" style="display: none;">
            <div class="sustainability-header">
                <span class="sustainability-title"><i class="fas fa-leaf"></i> Eco-Friendly Progress</span>
                <span class="eco-score" id="eco-score">0 Points</span>
            </div>
            <div class="progress-container"><div class="progress-fill" id="progress-fill"></div></div>
            <p id="bonus-info" class="bonus-info"></p>
        </div>

        <div class="total-section">
            <div class="price-row"><span>Subtotal:</span> <span id="subtotal">₹0.00</span></div>
            <div class="price-row original" id="original-total-row" style="display: none;"><span>Original:</span> <span id="original-total">$0.00</span></div>
            <div class="price-row final"><span>Final Total:</span> <span id="final-total">₹0.00</span></div>
            <button id="checkout-btn" class="checkout-btn" style="display: none;" onclick="processPayment()">Proceed to Payment</button>
        </div>
        
        <div class="games-section" style="text-align:center;">
            <button id="games-btn" class="games-btn">Play Challenges for Discounts!</button>
        </div>
    </main>

    <script src="js/main.js" defer></script>
    <script>
        const materialEcoPoints = { "jute": 25, "cotton": 20, "wood": 18, "herbs": 22, "clay": 15 };
        let currentDBProducts = [];

        document.addEventListener('meridianDataLoaded', (e) => {
            currentDBProducts = e.detail.products;
            renderCart();
        });

        function getCartItems() {
            const ids = JSON.parse(localStorage.getItem('cartItemIds')) || [];
            return ids.map(id => currentDBProducts.find(p => (p._id === id || p.id === id))).filter(Boolean);
        }

        function removeFromCart(productId) {
            let ids = JSON.parse(localStorage.getItem('cartItemIds')) || [];
            const index = ids.indexOf(productId);
            if (index > -1) ids.splice(index, 1);
            localStorage.setItem('cartItemIds', JSON.stringify(ids));
            renderCart();
            if (typeof updateCartCount === 'function') updateCartCount();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            const items = getCartItems();
            let subtotal = 0;

            container.innerHTML = items.length === 0 ? '<p style="text-align:center;">Empty cart.</p>' : '';

            items.forEach(item => {
                const pts = materialEcoPoints[item.material.toLowerCase()] || 0;
                subtotal += item.price;
                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.image}" class="cart-item-img">
                        <div class="cart-item-details">
                            <h4>${item.name} <span class="eco-points-badge">${pts} pts</span></h4>
                            <p class="cart-item-price">₹${item.price.toFixed(2)}</p>
                        </div>
                        <button onclick="removeFromCart('${item._id || item.id}')" style="background:var(--error-color); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Remove</button>
                    </div>`;
            });

            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('final-total').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('checkout-btn').style.display = items.length > 0 ? 'block' : 'none';
            
            updateEcoTracker(items);
        }

        function updateEcoTracker(items) {
            const tracker = document.getElementById('sustainability-tracker');
            if (items.length === 0) { tracker.style.display = 'none'; return; }
            
            tracker.style.display = 'block';
            let total = 0;
            items.forEach(i => total += (materialEcoPoints[i.material.toLowerCase()] || 0));
            const max = items.length * 25;
            const percent = (total / max) * 100;

            document.getElementById('eco-score').textContent = `${total} Points`;
            document.getElementById('progress-fill').style.width = `${percent}%`;
        }

        async function processPayment() {
            const amount = parseFloat(document.getElementById('final-total').textContent.replace('$', ''));
            try {
                const res = await fetch("http://localhost:5000/api/payment/order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ amount })
                });
                const order = await res.json();
                if (order.id) {
                    console.log("Razorpay Order Created:", order.id);
                    window.location.href = "success.html";
                }
            } catch (err) {
                alert("Server Connection Failed");
            }
        }
    </script>
</body>
</html>