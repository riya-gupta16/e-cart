<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meridian Marketplace - Global Impact</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Existing staggered layout styles preserved */
        .impact-dashboard-page { padding: 2rem 0; max-width: 1200px; margin: 0 auto; }
        .chart-grid { display: flex; flex-direction: column; gap: 4rem; padding: 0 2rem; }
        .impact-card { 
            display: flex; align-items: center; gap: 3rem; min-height: 400px; 
            background: #2a2a2a; border-radius: 15px; padding: 2rem; 
            opacity: 0; transform: translateY(30px); transition: all 0.6s ease-out;
        }
        .impact-card.animate { opacity: 1; transform: translateY(0); }
        .impact-card:nth-child(even) { flex-direction: row-reverse; }
        .chart-content { flex: 1; min-width: 0; }
        .chart-info { flex: 1; padding: 1rem; color: #fff; }
        .stat-value { color: #6A9362; font-weight: bold; font-size: 1.2rem; }
        canvas { max-width: 100%; height: 300px !important; }
        .loading-overlay { text-align: center; padding: 50px; font-size: 1.5rem; color: #6A9362; }
    </style>
</head>
<body>
    <header class="sticky-header">
        <nav class="main-nav">
            <a href="index.html" class="logo">Meridian</a>
            <ul class="nav-links">
                <li><a href="products.html">Shop</a></li>
                <li><a href="artisans.html">Artisans</a></li>
                <li><a href="impact.html">Impact</a></li>
            </ul>
        </nav>
    </header>

    <main id="impact-main">
        <div id="loading" class="loading-overlay">
            <i class="fas fa-spinner fa-spin"></i> Fetching Global Impact Data...
        </div>

        <section class="impact-dashboard-page" id="impact-content" style="display: none;">
            <h1>Our Global Impact</h1>
            <p>Your support directly contributes to these key areas of sustainability and artisan empowerment.</p>

            <div class="chart-grid">
                <div class="impact-card">
                    <div class="chart-info">
                        <h3>Artisans Supported</h3>
                        <p>Empowering creators across the globe.</p>
                        <div class="chart-stats">
                            <div class="stat-item">Total Artisans: <span id="total-artisans" class="stat-value">0</span></div>
                        </div>
                    </div>
                    <div class="chart-content"><canvas id="artisan-chart"></canvas></div>
                </div>

                <div class="impact-card">
                    <div class="chart-info">
                        <h3>Regional Diversity</h3>
                        <p>Preserving cultural heritage from multiple regions.</p>
                        <div class="stat-item">Regions Covered: <span id="total-regions" class="stat-value">0</span></div>
                    </div>
                    <div class="chart-content"><canvas id="region-chart"></canvas></div>
                </div>

                <div class="impact-card">
                    <div class="chart-info">
                        <h3>Sustainable Materials</h3>
                        <p>Distribution of eco-friendly materials used in our products.</p>
                    </div>
                    <div class="chart-content"><canvas id="material-chart"></canvas></div>
                </div>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/main.js" defer></script>
    <script>
        document.addEventListener('meridianDataLoaded', (e) => {
            const products = e.detail.products;
            const artisans = e.detail.artisans;

            // Hide loader and show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('impact-content').style.display = 'block';

            // Update Statistics
            document.getElementById('total-artisans').textContent = artisans.length;
            const regions = [...new Set(products.map(p => p.region))].filter(Boolean);
            document.getElementById('total-regions').textContent = regions.length;

            // Initialize Animations
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('animate'); });
            }, { threshold: 0.2 });
            document.querySelectorAll('.impact-card').forEach(card => observer.observe(card));

            // --- Generate Charts ---
            
            // 1. Artisan Chart (By Specialty)
            const specialtyCounts = {};
            artisans.forEach(a => {
                a.specialties?.forEach(s => specialtyCounts[s] = (specialtyCounts[s] || 0) + 1);
            });
            new Chart(document.getElementById('artisan-chart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(specialtyCounts),
                    datasets: [{
                        data: Object.values(specialtyCounts),
                        backgroundColor: ['#6A9362', '#B87B5B', '#5C77A2', '#D4A574']
                    }]
                }
            });

            // 2. Region Chart (Products per Region)
            const regionData = {};
            products.forEach(p => { if(p.region) regionData[p.region] = (regionData[p.region] || 0) + 1; });
            new Chart(document.getElementById('region-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(regionData).map(r => r.toUpperCase()),
                    datasets: [{
                        label: 'Products',
                        data: Object.values(regionData),
                        backgroundColor: '#5C77A2'
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });

            // 3. Material Chart
            const materialData = {};
            products.forEach(p => { if(p.material) materialData[p.material] = (materialData[p.material] || 0) + 1; });
            new Chart(document.getElementById('material-chart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(materialData),
                    datasets: [{
                        data: Object.values(materialData),
                        backgroundColor: ['#6A9362', '#B87B5B', '#D4A574', '#C76B6B', '#8FA6D4']
                    }]
                }
            });
        });
    </script>
</body>
</html>